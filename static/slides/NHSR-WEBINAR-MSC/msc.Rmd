---
title: "Forecasting multiple seasonality"
subtitle: ""
author: "<br> <br> Bahman Rostami-Tabar <br>"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["xaringan-themer.css", "slides-style.css"]
    nature:
      highlightStyle: solarized-light
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
      slideNumberFormat: |
        <div class="progress-bar-container">
          <div class="progress-bar" style="width: calc(%current% / %total% * 100%);">
          </div>
        </div>
---

```{r child = "../setup.Rmd"}
```

```{r set-theme, include=FALSE}
library(xaringanthemer)
style_duo_accent(
  primary_color      = "#0077bb", # pantone classic blue0F4C81
  secondary_color    = "#33BBEE", # pantone baby blueB6CADA
  header_font_google = google_font("Raleway"),
  text_font_google   = google_font("Raleway", "300", "300i"),
  code_font_google   = google_font("Source Code Pro"),
  text_font_size     = "30px"
)
```

```{r package, include=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(fpp3)
library(kableExtra)
library(ggthemes)
library(scales)
library(readxl)
```


class: inverse
background-image: linear-gradient(to right, rgba(150, 150, 150, .1), rgba(150, 150, 150, .4)), url("img/ae.jpg")
background-size: cover

### Temporal data granularity in the healthcare sector

- Hospital admission
- A&E attendance
- GP visit
- NHS 111
- Clinical Support Desk
- etc

---

### Clinical Support Desk

```{r example1, echo=FALSE, fig.align='center'}
library(readxl)
csd <- 
  read_excel("data/cds.xls")
csd %>% head(n=8) %>% kbl() %>% kable_classic(full_width = F, html_font = "Cambria",font_size = 24) %>% column_spec(1:6,background = "white")
```

---

### Clinical Support Desk

```{r example11, echo=FALSE, fig.align='center'}
library(readxl)
csd <- 
  read_excel("data/cds.xls")
csd %>% head(n=8) %>% kbl() %>% kable_classic(full_width = F, html_font = "Cambria",font_size = 24) %>% column_spec(1:6,background = "white") %>% 
  column_spec(2, color = "white", background = "#D7261E")
```


---

## Accident & Emergency Departement

```{r example2, echo=FALSE, fig.align='center'}
library(readr)
ae_original <- readr::read_csv("data/ae_uk.csv",
col_types = cols(arrival_time=col_datetime(format = "%d/%m/%Y %H:%M")))
ae_original %>% head(n=12) %>% kbl() %>% kable_classic(full_width = F, html_font = "Cambria",font_size = 24) %>% column_spec(1:4,background = "white")
```

---

## Accident & Emergency Departement

```{r example22, echo=FALSE, fig.align='center'}
library(readr)
ae_original <- readr::read_csv("data/ae_uk.csv",
col_types = cols(arrival_time=col_datetime(format = "%d/%m/%Y %H:%M")))
ae_original %>% head(n=12) %>% kbl() %>% kable_classic(full_width = F, html_font = "Cambria",font_size = 24) %>% column_spec(1:4,background = "white") %>% column_spec(4, color = "white", background = "#D7261E")
```

---

- The temporal variable (e.g. arrival_time) contains many information:

    - year, semester, quarter, month, etc
  
- We can create different time series for each frequency e.g. Half-an-Hourly, Hourly, Daily, Weekly, Monthly, Quarterly, Yearly

---

### Do we need to generate forecasts at all levels?
  
- In modern organisations, forecasts are required to inform decisions at multiple level of granularity e.g. scheduling, staffing, recruitment;

--

- Forecasts can be generated at the desired level of granularity corresponding to the decision level;

--

- Alternatively, they could be generated at all levels and then combined using `temporal reconciliation`

---

class: middle

.bitlarger[In this webinar, we will show you how to go through various steps of a `tidy time series forecasting` using the `A&E dataset`.]

---

## Tidy time series forecasting workflow

```{r workflow, echo = FALSE}
line_curve <- function(x, y, xend, yend, ...){
  geom_curve(
    aes(x = x, y = y, xend = xend, yend = yend),
    arrow = arrow(type = "closed", length = unit(0.03, "npc")),
    ...
  )
}

ggplot() +
  geom_text(
    aes(x = x, y = y, label = label),
    data = tribble(
      ~ x, ~ y, ~ label,
      1, 0, "Tidy",
      7/3, 0, "Visualise",
      3, 0.5, "Specify",
      11/3, 0, "Estimate",
      3, -0.5, "Evaluate",
      5, 0, "Forecast"
    ),
    size = 5
  ) +
  geom_segment(
    aes(x = x, y = y, xend = xend, yend = yend),
    data = tribble(
      ~ x, ~ y, ~ xend, ~ yend,
      1.3, 0, 1.9, 0,
      4.1, 0, 4.6, 0
    ),
    arrow = arrow(type = "closed", length = unit(0.03, "npc"))
  ) +
  line_curve(7/3, 0.1, 8/3, 0.5, angle = 250, curvature = -0.3) +
  line_curve(10/3, 0.5, 11/3, 0.1, angle = 250, curvature = -0.3) +
  line_curve(8/3, -0.5, 7/3, -0.1, angle = 250, curvature = -0.3) +
  line_curve(11/3, -0.1, 10/3, -0.5, angle = 250, curvature = -0.3) +
  theme_void() +
  xlim(0.8, 5.2) +
  ylim(-0.6, 0.6) +
  coord_equal(ratio = 1)
```

---

.three-column[

```{r tsibble, echo=FALSE}
knitr::include_graphics("img/tsibble.svg")
```
]

.three-column[
### 
```{r FABLE, echo=FALSE}
knitr::include_graphics("img/feasts.svg")
```
]

.three-column[
```{r FEAST, echo=FALSE}
knitr::include_graphics("img/fable.svg")
```
]


---

## Steps in preparing data for forecasting (tidy)

```{r tidy_step, fig.align='center',echo=FALSE, out.width='60%'}
knitr::include_graphics("img/tsibble_step.jpg")
```

---

.pull-left[
### Import A&E data
```{r ae, echo=TRUE}
ae <- 
readr::read_csv("data/ae_uk.csv",
col_types = 
cols(arrival_time
=col_datetime(format = "%d/%m/%Y %H:%M"))) %>% 
  mutate(arrival_time=
           lubridate::force_tz(arrival_time,tz="GB"))
```
]

.pull-right[
```{r ae1, echo=FALSE}
ae <- 
readr::read_csv("data/ae_uk.csv",
col_types = 
cols(arrival_time
=col_datetime(format = "%d/%m/%Y %H:%M"))) %>% 
  mutate(arrival_time=
           lubridate::force_tz(arrival_time,tz="GB"))
ae
```
]

---

class: inverse
background-image: linear-gradient(to right, rgba(150, 150, 150, .1), rgba(150, 150, 150, .4)), url("img/time.jpg")
background-size: cover

## Create time series with `tsibble`

---

class: middle

.huge-bahman-text[A `time series` can be thought of as a list of numbers (the measurements), along with some information about what times those numbers were recorded (the index). This information can be stored as a `tsibble` object in R.]

---

## Time series in R

.hand[Why do we need `tsibble`?]

- Depending on which package you use for time series forecasting, you may need different data structures:

    - `ts(), zoo(), xts(), etc`
  
- difficult to work with tidyverse
- irregular time interval
- multiple measured variables
- multiple grouping variables

---

## What is `tsibble`?

**In tsibble:**

  + An index: time information about the observation
  + Key variable(s): set of variables that define observational units over time
  + Measured variable(s): numbers of interest

* It works with tidyverse functions.

---

.pull-left[
### Create a tsibble with A&E data
```{r ts, echo=TRUE}
ae_tsb <- ae %>%
  as_tsibble(
    key = c(ID,gender,type_injury),
    index = arrival_time, 
    regular=FALSE)
```
]

.pull-right[
```{r ts1, echo=FALSE}
ae_tsb <- ae %>%
  as_tsibble(
    key = c(ID,gender,type_injury),
    index = arrival_time, 
    regular=FALSE)
ae_tsb
```
]

---

.pull-left[
### Create an equally spaced interval (a regular index)
```{r regularised, echo=TRUE}
ae_half_hourly <- 
ae_tsb %>%
index_by(time = 
lubridate::floor_date(arrival_time, 
"30 minutes")) %>%
summarise(
admission=n())
```
]

.pull-right[
```{r regularised1, echo=FALSE}
ae_half_hourly <- ae_tsb %>%
  index_by(time = lubridate::floor_date(arrival_time, "30 minutes")) %>%
  summarise(admission=n())
ae_half_hourly
```
]

---

.pull-left[
### Check for temporal gap
```{r temporalgap, echo=TRUE}
ae_half_hourly %>% has_gaps()#check if any temporal gaps
```
]

.pull-right[
```{r temporalgap1, echo=FALSE}
ae_half_hourly %>% has_gaps()#check if any temporal gaps
```
]

---

.pull-left[
### fix the temporal gap
```{r fillgap, echo=TRUE}
ae_half_hourly_without_gap <- 
  ae_half_hourly %>% 
  fill_gaps(admission=0L)
```
]

.pull-right[
```{r fillgap1, echo=FALSE}
ae_half_hourly_without_gap <- 
  ae_half_hourly %>% 
  fill_gaps(admission=0L)
ae_half_hourly_without_gap
```
]

---

## Multiple seasonality

.hand[What do we mean by seasonality/ multiple seasonality?]

- `seasonality` is a regularly repeating pattern of highs and lows related to calendar time such as seasons, quarters, months, days of the week, hour of the  day and so on?

- If at least two types of seasonality exist in the time series, then we talk about multiple seasonality.


---

### Monthly Seasonal Plot

```{r createmonthlyp1, echo=FALSE, message=FALSE,warning=FALSE,out.width="70%", fig.align='center'}
ae_monthly <- ae_half_hourly_without_gap %>% 
  index_by(ae_month=yearmonth(time)) %>% 
  summarise(admission=sum(admission))
ae_monthly %>% gg_season()
```

---

### Daily Seasonal Plot

```{r dailyp1, echo=FALSE, message=FALSE,warning=FALSE,out.width="70%", fig.align='center'}
ae_daily <- ae_half_hourly_without_gap %>% 
  index_by(day_of_week=as_date(time)) %>% 
  summarise(admission=sum(admission))

ae_daily %>% gg_season(admission, period = "week")+
  theme(legend.position = "")
```

---

### Hourly Seasonal Plot

```{r hourly, echo=FALSE,message=FALSE,warning=FALSE,out.width="70%", fig.align='center'}
ae_hourly <- ae_half_hourly_without_gap %>%
  index_by(hour= lubridate::floor_date(time, "1 hour")) %>%
  summarise(admission=sum(admission)) 

ae_hourly %>% gg_season(period="day")+
  theme(legend.position = "")
```

## Fourier terms

.pull-left[
Captures seasonal distribution with a continuous periodic functions.

✅ Handles non-integer seasonality (days in year, weeks in month).

✅ Flexibility of seasonal pattern controllable by number of harmonics.

❌ More complicated to interpret.
]

.pull-right[
```{r fourier-plot-2, ref.label="fourier-plot", fig.height = 10}
```
]

---

.hand-large[thank you!]

- Email [rostami-tabarb@cardiff.ac.uk](mailto:rostami-tabarb@cardiff.ac.uk)

- Website [www.bahmanrt.com](www.bahmanrt.com)

- Twitter [@Bahman_R_T](https://twitter.com/Bahman_R_T)